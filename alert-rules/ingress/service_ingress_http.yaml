groups:
- name: service-ingress
  rules:
  # ------------------------------------------------------------------
  # 1. ERROR RATES
  # ------------------------------------------------------------------

  # 2.10 Error 5xx (Server Errors)
  # Logic: Error rate > 5% AND Total requests > 0.5 req/s (avoid alerting on 1 error/hour)
  - alert: IngressHigh5xxRate
    expr: |
      (
        sum by (host) (rate(nginx_ingress_controller_requests{status=~"50[0-24-9]|5[1-9][0-9]", host!="_"}[5m]))
        /
        sum by (host) (rate(nginx_ingress_controller_requests{host!="_"}[5m]))
        * 100 > 5
      )
      and
      (
        sum by (host) (rate(nginx_ingress_controller_requests{host!="_"}[5m])) > 0.5
      )
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "High 5xx error rate on {{ $labels.host }}"
      description: "Domain {{ $labels.host }} has high 5xx error rate: {{ $value | printf \"%.2f\" }}%."

  - alert: IngressHigh503Rate
    expr: |
      (
        sum by (host) (rate(nginx_ingress_controller_requests{status="503", host!="_"}[5m]))
        /
        sum by (host) (rate(nginx_ingress_controller_requests{host!="_"}[5m]))
        * 100 > 5
      )
      and
      (
        sum by (host) (rate(nginx_ingress_controller_requests{host!="_"}[5m])) > 0.5
      )
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "High 5xx error rate on {{ $labels.host }}"
      description: "Domain {{ $labels.host }} has high 503 error rate: {{ $value | printf \"%.2f\" }}%."
        
  # 2.11 Error 4xx (Client Errors)
  # Kept absolute threshold (> 20 req/s) as percentage can be noisy for 4xx (scanners)
  - alert: IngressHigh4xxRate
    expr: sum by (host) (rate(nginx_ingress_controller_requests{status=~"4..", host!="_"}[5m])) > 20
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High 4xx error rate on {{ $labels.host }}"
      description: "Domain {{ $labels.host }} has high 4xx error rate: {{ $value | printf \"%.2f\" }} req/s."

  # ------------------------------------------------------------------
  # 2. LATENCY
  # ------------------------------------------------------------------

  # 2.12 Response Time (P95) General slowness (Majority of users)
  - alert: HighLatencyP95
    expr: histogram_quantile(0.95, sum by (le, host) (rate(nginx_ingress_controller_request_duration_seconds_bucket{host!="_"}[5m]))) > 2.0
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High Latency P95 on {{ $labels.host }}"
      description: "95% of requests to {{ $labels.host }} take {{ $value | printf \"%.2f\" }}s (Threshold: 2.0s)."

  # 2.12 (Extra) Response Time (P99) Tail latency (Extreme outliers)
  - alert: HighLatencyP99
    expr: histogram_quantile(0.99, sum by (le, host) (rate(nginx_ingress_controller_request_duration_seconds_bucket{host!="_"}[5m]))) > 3.0
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High Latency P99 on {{ $labels.host }}"
      description: "99% of requests to {{ $labels.host }} take {{ $value | printf \"%.2f\" }}s (Threshold: 3.0s)."

  # ------------------------------------------------------------------
  # 3. TRAFFIC ANOMALIES
  # ------------------------------------------------------------------

  # 2.13 Traffic Drop
  # Logic: Traffic is 0 NOW, BUT was active (> 1 req/s) 30 mins ago.
  # Prevents alerts for domains that were deleted or never had traffic.
  - alert: TrafficDropToZero
    expr: |
      (
        sum by (host) (rate(nginx_ingress_controller_requests{host!="_"}[5m])) == 0
      )
      and
      (
        sum by (host) (rate(nginx_ingress_controller_requests{host!="_"}[5m] offset 30m)) > 1
      )
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "Traffic dropped to zero on {{ $labels.host }}"
      description: "Traffic to {{ $labels.host }} disappeared completely (was active 30m ago)."

  # ------------------------------------------------------------------
  # 4. INFRASTRUCTURE & CERTIFICATES (NEW!)
  # ------------------------------------------------------------------

  # Check if Nginx config reload failed (bad ingress yaml)
  - alert: NginxConfigReloadFailed
    expr: nginx_ingress_controller_config_last_reload_successful == 0
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "Nginx Ingress config reload failed"
      description: "Nginx cannot apply new configuration. Controller pod: {{ $labels.controller_pod }}"

  # SSL Certificate Expiry (Critical for Hosts)
  # Alerts: 14 days (Warning), 7 days (Critical)
  - alert: NginxSSLCertExpiringSoon
    expr: (nginx_ingress_controller_ssl_expire_time_seconds - time()) < (14 * 24 * 3600)
    for: 1h
    labels:
      severity: warning
    annotations:
      summary: "SSL Cert expiring for {{ $labels.host }}"
      description: "Certificate for {{ $labels.host }} expires in {{ $value | humanizeDuration }}."

  - alert: NginxSSLCertExpiringCritical
    expr: (nginx_ingress_controller_ssl_expire_time_seconds - time()) < (7 * 24 * 3600)
    for: 1h
    labels:
      severity: critical
    annotations:
      summary: "SSL Cert expiring CRITICAL for {{ $labels.host }}"
      description: "Certificate for {{ $labels.host }} expires in {{ $value | humanizeDuration }}. RENEW NOW!"

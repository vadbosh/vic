# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ –Ω–∞ Terraform

## üîπ –í–∞–∂–Ω–æ

* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ—Ö–∞–Ω–∏–∑–º `terraform_remote_state` –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏.

  * –ö–æ–º–ø–æ–Ω–µ–Ω—Ç `1.VPC/` —Å–æ–∑–¥–∞—ë—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥—Ä—É–≥–∏–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º.

  * –ö–æ–º–ø–æ–Ω–µ–Ω—Ç `2.EKS-CORE/` –Ω–∞—Å–ª–µ–¥—É–µ—Ç —ç—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

```hcl
s3_key_vpc_data¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† = "ap-southeast-2/cluster_name/vpc-a/terraform.tfstate"
s3_key_eks_data¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† = "ap-southeast-2/cluster_name/eks-core-a/terraform.tfstate"
```

  * –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∞—Å–ª–µ–¥—É–µ—Ç (–∏—Å–ø–æ–ª—å–∑—É—é—Ç) –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –º–µ—Ö–∞–Ω–∏–∑–º data "terraform\_remote\_state" :

```hcl
data "terraform_remote_state" "network" {
  backend = "s3"
  config = {
    bucket = "bucket_name"
    key    = var.s3_key_vpc_data
    region = "us-east-1"
  }
}
```

* –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –î–û–õ–ñ–ï–ù –±—ã—Ç—å –∑–∞–¥–∞–Ω —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π backend (s3) —á–µ—Ä–µ–∑ —Ñ–∞–π–ª `_MOD_backend-config.tfvars`. –≠—Ç–æ—Ç —Ñ–∞–π–ª –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è Terraform –∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–¥–∞–Ω –î–û –∑–∞–ø—É—Å–∫–∞ `init`.

## 1. –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –æ–±–ª–∞—á–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤ AWS —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Terraform. –û–Ω —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫—É:

* —Å–µ—Ç–µ–≤–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (VPC);
* –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes (EKS);
* –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ (CRD, Helm, ingress –∏ –ø—Ä.);
* –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ VPN (Bastion);
* –ø–∏—Ä–∞ –º–µ–∂–¥—É VPC (Peering);
* –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ —Ä–æ–ª–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

## 2. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

* Terraform >= 1.0
* AWS CLI, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
* –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ AWS –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞–º–∏ (EC2, IAM, EKS, VPC –∏ –ø—Ä.)

## 3. –û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### 3.1 VPC (1.VPC)

* **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: —Å–æ–∑–¥–∞—ë—Ç —Å–µ—Ç—å VPC —Å –ø–æ–¥—Å–µ—Ç—è–º–∏, –º–∞—Ä—à—Ä—É—Ç–∞–º–∏, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—à–ª—é–∑–∞–º–∏.

* **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**: —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥—Å–µ—Ç–µ–π –¥–ª—è EKS, —ç–∫—Å–ø–æ—Ä—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ Outputs.

### 3.2 EKS-CORE (2.EKS-CORE)

* **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes —Å node group‚Äô–∞–º–∏.

* **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Pod Identity, IAM —Ä–æ–ª–µ–π –∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö SG, —ç–∫—Å–ø–æ—Ä—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ Outputs.

### 3.3 EKS-SERVICES (3.EKS-SERVICES)

* **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ –≤–Ω—É—Ç—Ä–∏ EKS-–∫–ª–∞—Å—Ç–µ—Ä–∞ (ALB, autoscaler, ingress –∏ –¥—Ä.).

* **–ú–æ–¥—É–ª–∏**: `modules/rbac-*`, `modules/helm-version`

### 3.4 EKS-CRD (4.EKS-CRD)

* **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: —É—Å—Ç–∞–Ω–æ–≤–∫–∞ CRD –∏ —Å–µ—Ç–µ–≤—ã—Ö –ø–æ–ª–∏—Ç–∏–∫ (KEDA, cert-manager, Cilium).

* **–ú–æ–¥—É–ª–∏**: `modules/helm-version`

### 3.5 PEERING

* **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ VPC Peering –º–µ–∂–¥—É **VPC –≤ –æ–¥–Ω–æ–º –∏–ª–∏ —Ä–∞–∑–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–∞—Ö AWS**.

* **–í–∞–∂–Ω–æ**: PEERING –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä—è–º—É—é —Å–≤—è–∑—å –º–µ–∂–¥—É `cluster-a` –∏ `cluster-b` –∫–∞–∫ –∫–ª–∞—Å—Ç–µ—Ä–∞–º–∏, –∞ —Ç–æ–ª—å–∫–æ –º–µ–∂–¥—É VPC EKS –∏ –¥—Ä—É–≥–∏–º–∏ VPC.

### 3.6 BASTION-VPN

* **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: —Å–æ–∑–¥–∞–Ω–∏–µ bastion-—Ö–æ—Å—Ç–∞ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ VPC.

## 4. –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ

–ü–æ—Ä—è–¥–æ–∫ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è (–∫–ª–∞—Å—Ç–µ—Ä `cluster-b` ‚Äî —Ä–µ–∑–µ—Ä–≤–Ω—ã–π):

1. `cluster-a/1.VPC`
2. `cluster-b/1.VPC`
3. `BASTION-VPN` ‚Äî –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ VPN —Å–µ—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ OpenVPN
4. `PEERING` ‚Äî —Å–æ–∑–¥–∞—ë—Ç —Å–≤—è–∑—å –º–µ–∂–¥—É VPC –≤ –æ–¥–Ω–æ–º –∏–ª–∏ —Ä–∞–∑–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–∞—Ö AWS
5. `cluster-a/2.EKS-CORE` ‚Äî –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è `EKS-CORE` –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å `Kube config` –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–ª–∞—Å—Ç–µ—Ä—É –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤   
    `aws eks --region us-east-1 update-kubeconfig --name cluster-name`
6. `cluster-a/3.EKS-SERVICES`
7. `cluster-a/4.EKS-CRD`

–ü–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ **–≤—Å–µ —Ñ–∞–π–ª—ã –≤–∏–¥–∞** "*\_MOD\_*" –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ –∫–∞–∂–¥–æ–º —Ä–∞–∑–¥–µ–ª–µ.

### –ö–æ–º–∞–Ω–¥—ã —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–Ω–∏—è

```bash
terraform init -backend-config="_MOD_backend-config.tfvars"
terraform validate
terraform plan 
terraform apply
```

## 5. –£–¥–∞–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

–£–¥–∞–ª–µ–Ω–∏—é –ø–æ–¥–ª–µ–∂–∞—Ç **–¢–û–õ–¨–ö–û** —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±—É—é—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è):

* `cluster-a/4.EKS-CRD` -> `cluster-a/3.EKS-SERVICES` -> `cluster-a/2.EKS-CORE`

–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:

```bash
terraform destroy
```

## 6. –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –∫–ª–∞—Å—Ç–µ—Ä—ã `cluster-a` –∏ `cluster-b`.
* –í–Ω—É—Ç—Ä–∏ EKS –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Helm, IAM Roles for Service Accounts (IRSA) –∏ –¥—Ä—É–≥–∏–µ best practices AWS.

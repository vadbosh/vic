groups:
  - name: ingress-target-stats-sns
    rules:
      # 1. Target Response Time (P95 Latency)
      # Logic: Calculates the 95th percentile of request duration per service over 5 minutes.
      # Equivalent to AWS ALB "Target Response Time".
      #- alert: NginxTargetResponseTimeHigh
      #  expr: histogram_quantile(0.95, sum by (le, namespace, host) (rate(nginx_ingress_controller_request_duration_seconds_bucket{host!="_"}[5m]))) > 0.3
      #  for: 2m
      #  labels:
      #    severity: critical4sns
      #    type: backend_stats
      #  annotations:
      #    summary: "High Latency: {{ $labels.namespace }}/{{ $labels.host }}"
      #    description: "{{ $labels.host }} The P95 response time is {{ $value | humanizeDuration }} over the last 5 minutes (threshold: >300ms)."

      - alert: NginxTargetResponseTimeHigh2000SNS
        expr: |
          histogram_quantile(
               0.95,sum(rate
               (
               nginx_ingress_controller_request_duration_seconds_bucket{
               host=~"thoth.monolith.demo.wellnessliving.com|web.thoth.monolith.staging.wellnessliving.com|debug.staging.wellnessliving.com"}[5m]
               )
          ) by(le,namespace,host)) > 2
        for: 2m
        labels:
          severity: critical4sns
          type: backend_stats
        annotations:
          summary: "High Latency: {{ $labels.namespace }}/{{ $labels.host }}"
          description: "{{ $labels.host }} The P95 response time is {{ $value | humanizeDuration }} over the last 5 minutes (threshold: >2000ms)."

      - alert: NginxTargetResponseTimeHigh200SNS
        expr: |
          histogram_quantile(
               0.95,sum(rate
               (
               nginx_ingress_controller_request_duration_seconds_bucket{
               host=~"staging.wellnessliving.com|thoth.downpage.staging.wellnessliving.com"}[5m]
               )
          ) by(le,namespace,host)) > 0.2
        for: 2m
        labels:
          severity: critical4sns
          type: backend_stats
        annotations:
          summary: "High Latency: {{ $labels.namespace }}/{{ $labels.host }}"
          description: "{{ $labels.host }} The P95 response time is {{ $value | humanizeDuration }} over the last 5 minutes (threshold: >200ms)."

      - alert: NginxTargetResponseTimeHigh600SNS
        expr: |
          histogram_quantile(
               0.95,sum(rate
               (
               nginx_ingress_controller_request_duration_seconds_bucket{
               host=~"dev-drive.ms.thoth.wellnessliving.com"}[5m]
               )
          ) by(le,namespace,host)) > 0.6
        for: 2m
        labels:
          severity: critical4sns
          type: backend_stats
        annotations:
          summary: "High Latency: {{ $labels.namespace }}/{{ $labels.host }}"
          description: "{{ $labels.host }} The P95 response time is {{ $value | humanizeDuration }} over the last 5 minutes (threshold: >600ms)."

      - alert: NginxTargetResponseTimeHigh900SNS
        expr: |
          histogram_quantile(
               0.95,sum(rate
               (
               nginx_ingress_controller_request_duration_seconds_bucket{
               host=~"debug.demo.wellnessliving.com"}[5m]
               )
          ) by(le,namespace,host)) > 0.9
        for: 2m
        labels:
          severity: critical4sns
          type: backend_stats
        annotations:
          summary: "High Latency: {{ $labels.namespace }}/{{ $labels.host }}"
          description: "{{ $labels.host }} The P95 response time is {{ $value | humanizeDuration }} over the last 5 minutes (threshold: >900ms)."
